name: Sync upstream (mirror + reminder)

on:
  workflow_dispatch:
    inputs:
      upstream_repo:
        description: "Upstream repo in OWNER/REPO format (default: gem5/website)"
        required: false
        default: "gem5/website"
      upstream_branch:
        description: "Upstream branch name (default: stable)"
        required: false
        default: "stable"
  schedule:
    - cron: "17 3 * * 1" # every Monday 03:17 UTC

permissions:
  contents: write
  issues: write

jobs:
  mirror-and-remind:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve upstream coordinates
        id: upstream
        run: |
          UPSTREAM_REPO="${{ inputs.upstream_repo }}"
          UPSTREAM_BRANCH="${{ inputs.upstream_branch }}"

          if [ -z "$UPSTREAM_REPO" ]; then
            UPSTREAM_REPO="gem5/website"
          fi
          if [ -z "$UPSTREAM_BRANCH" ]; then
            UPSTREAM_BRANCH="stable"
          fi

          echo "repo=$UPSTREAM_REPO" >> "$GITHUB_OUTPUT"
          echo "branch=$UPSTREAM_BRANCH" >> "$GITHUB_OUTPUT"
          echo "url=https://github.com/${UPSTREAM_REPO}.git" >> "$GITHUB_OUTPUT"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: |
          git remote remove upstream 2>/dev/null || true
          git remote add upstream "${{ steps.upstream.outputs.url }}"
          git fetch --prune upstream "${{ steps.upstream.outputs.branch }}"

      - name: Determine old/new upstream-main
        id: head
        run: |
          if git show-ref --verify --quiet refs/remotes/origin/upstream-main; then
            OLD="$(git rev-parse origin/upstream-main)"
          else
            OLD=""
          fi
          NEW="$(git rev-parse "upstream/${{ steps.upstream.outputs.branch }}")"
          echo "old=$OLD" >> "$GITHUB_OUTPUT"
          echo "new=$NEW" >> "$GITHUB_OUTPUT"

      - name: Update upstream-main branch (force mirror)
        run: |
          git checkout -B upstream-main "upstream/${{ steps.upstream.outputs.branch }}"
          git push --force origin upstream-main

      - name: Create reminder issue when upstream changes
        if: ${{ steps.head.outputs.old != steps.head.outputs.new }}
        uses: actions/github-script@v7
        with:
          script: |
            const upstreamRepo = `${{ steps.upstream.outputs.repo }}`;
            const upstreamBranch = `${{ steps.upstream.outputs.branch }}`;
            const oldSha = `${{ steps.head.outputs.old }}`;
            const newSha = `${{ steps.head.outputs.new }}`;

            const title = `sync: upstream updated (${upstreamRepo}@${upstreamBranch} -> ${newSha.slice(0, 7)})`;
            const compareLine = oldSha
              ? `- Upstream compare: https://github.com/${upstreamRepo}/compare/${oldSha}...${newSha}`
              : `- Upstream new head: https://github.com/${upstreamRepo}/commit/${newSha}`;

            const body = [
              "检测到上游有更新，本仓库已将 `upstream-main` 强制镜像到最新上游提交。",
              "",
              compareLine,
              "",
              "建议同步流程（保持 `main` 随时可部署）：",
              "- 从 `main` 拉出 `sync/YYYYMMDD` 分支",
              "- `git merge upstream-main`（本地解决冲突并确认站点能构建）",
              "- 提 PR: `sync/YYYYMMDD` -> `main`",
              "",
              "注意：不要直接在 `main` 上处理冲突；让 PR 承载同步与审查。",
            ].join("\\n");

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
            });
